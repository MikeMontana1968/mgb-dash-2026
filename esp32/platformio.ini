; MGB Dash 2026 — PlatformIO Multi-Environment Configuration
;
; Build all:    pio run
; Build one:    pio run -e servo_fuel
; Flash one:    pio run -e servo_fuel -t upload

[platformio]
default_envs = servo_fuel, servo_amps, servo_temp, speedometer, body_controller

; ── Shared defaults ────────────────────────────────────────────────
[env]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
lib_deps =
    adafruit/Adafruit NeoPixel@^1.12.3
    madhephaestus/ESP32Servo@^3.0.6
build_flags =
    -I../common/cpp
    -DCORE_DEBUG_LEVEL=5
    -DCAN_TX_PIN=5
    -DCAN_RX_PIN=4
    -DLED_DATA_PIN=14
    -DLED_COUNT=12
    -DSERVO_PIN=27

; ── Servo Gauges ───────────────────────────────────────────────────
[env:servo_fuel]
build_src_filter = +<servo_gauge/>
build_flags =
    ${env.build_flags}
    -DGAUGE_ROLE=FUEL
    -DGAUGE_ROLE_NAME='"FUEL "'
    -DLOG_ROLE=LogRole::FUEL

[env:servo_amps]
build_src_filter = +<servo_gauge/>
build_flags =
    ${env.build_flags}
    -DGAUGE_ROLE=AMPS
    -DGAUGE_ROLE_NAME='"AMPS "'
    -DLOG_ROLE=LogRole::AMPS

[env:servo_temp]
build_src_filter = +<servo_gauge/>
build_flags =
    ${env.build_flags}
    -DGAUGE_ROLE=TEMP
    -DGAUGE_ROLE_NAME='"TEMP "'
    -DLOG_ROLE=LogRole::TEMP
    ; !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    ; TODO(HARDWARE): TEMP gauge prototype has LED on GPIO 18 — rewire
    ;   to GPIO 14 to match FUEL/AMPS standard, then remove this override
    ; !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    ; -DLED_DATA_PIN=18

; ── Speedometer ────────────────────────────────────────────────────
[env:speedometer]
build_src_filter = +<speedometer/>
build_flags =
    ${env.build_flags}
    -DGAUGE_ROLE=SPEED
    -DGAUGE_ROLE_NAME='"SPEED"'
    -DLOG_ROLE=LogRole::SPEED
    ; Stepper motor (28BYJ-48 + ULN2003)
    -DSTEPPER_STEP_PIN=25
    -DSTEPPER_DIR_PIN=26
    ; TODO(HARDWARE): STEPPER_EN was 27 but conflicts with shared SERVO_PIN=27.
    ;   Reassign when wiring speedometer prototype.
    -DSTEPPER_EN_PIN=33
    ; eInk display (Waveshare 1.54" tri-color, SPI)
    -DEINK_MOSI_PIN=23
    -DEINK_SCK_PIN=18
    ; TODO(HARDWARE): eInk CS was 5, BUSY was 4 — conflicts with shared
    ;   CAN_TX_PIN=5, CAN_RX_PIN=4. Reassign when wiring speedometer prototype.
    -DEINK_CS_PIN=15
    -DEINK_DC_PIN=17
    -DEINK_RST_PIN=16
    -DEINK_BUSY_PIN=2

; ── Body Controller ────────────────────────────────────────────────
[env:body_controller]
build_src_filter = +<body_controller/>
build_flags =
    ${env.build_flags}
    -DGAUGE_ROLE=BODY
    -DGAUGE_ROLE_NAME='"BODY "'
    -DLOG_ROLE=LogRole::BODY
    -DHALL_SENSOR_PIN=27
    -DKEY_ON_PIN=32
    -DBRAKE_PIN=33
    -DREGEN_PIN=25
    -DFAN_PIN=26
    -DREVERSE_PIN=34
    -DLEFT_TURN_PIN=35
    -DRIGHT_TURN_PIN=36
    ; Drivetrain constants
    -DDIFF_RATIO=3.909
    -DTIRE_DIAMETER_IN=26.5
    ; MGB 4-speed gear ratios (see docs/vehicle-specs.md)
    -DGEAR_RATIO_1=3.41
    -DGEAR_RATIO_2=2.166
    -DGEAR_RATIO_3=1.38
    -DGEAR_RATIO_4=1.00
    -DGEAR_RATIO_REV=3.09
    -DGEAR_TOLERANCE=0.15
    ; Odometer persistence
    -DODO_PERSIST_MILES=0.5
