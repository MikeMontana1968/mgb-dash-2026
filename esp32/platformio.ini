; MGB Dash 2026 — PlatformIO Multi-Environment Configuration
;
; Build all:    pio run
; Build one:    pio run -e servo_fuel
; Flash one:    pio run -e servo_fuel -t upload

[platformio]
default_envs = servo_fuel, servo_amps, servo_temp, speedometer, body_controller

; ── Shared defaults ────────────────────────────────────────────────
[env]
platform = espressif32
board = esp32dev
framework = arduino
monitor_speed = 115200
extra_scripts = pre:pre_build_version.py
lib_deps =
    adafruit/Adafruit NeoPixel@^1.12.3
    madhephaestus/ESP32Servo@^3.0.6
build_flags =
    -I../common/cpp
    -DCORE_DEBUG_LEVEL=5
    -DPIN_CAN_TX=5
    -DPIN_CAN_RX=4
    -DPIN_LED_DATA=14
    -DLED_COUNT=12
    -DPIN_SERVO=27

; ── Servo Gauges ───────────────────────────────────────────────────
[env:servo_fuel]
build_src_filter = +<servo_gauge/>
build_flags =
    ${env.build_flags}
    -DGAUGE_ROLE=FUEL
    -DGAUGE_ROLE_NAME='"FUEL "'
    -DLOG_ROLE=LogRole::FUEL

[env:servo_amps]
build_src_filter = +<servo_gauge/>
build_flags =
    ${env.build_flags}
    -DGAUGE_ROLE=AMPS
    -DGAUGE_ROLE_NAME='"AMPS "'
    -DLOG_ROLE=LogRole::AMPS

[env:servo_temp]
build_src_filter = +<servo_gauge/>
build_flags =
    ${env.build_flags}
    -DGAUGE_ROLE=TEMP
    -DGAUGE_ROLE_NAME='"TEMP "'
    -DLOG_ROLE=LogRole::TEMP
    ; !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    ; TODO(HARDWARE): TEMP gauge prototype has LED on GPIO 18 — rewire
    ;   to GPIO 14 to match FUEL/AMPS standard, then remove this override
    ; !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
    ; -DPIN_LED_DATA=18

; ── Speedometer ────────────────────────────────────────────────────
[env:speedometer]
build_src_filter = +<speedometer/>
build_flags =
    ${env.build_flags}
    -DGAUGE_ROLE=SPEED
    -DGAUGE_ROLE_NAME='"SPEED"'
    -DLOG_ROLE=LogRole::SPEED
    ; Stepper motor (28BYJ-48 + ULN2003)
    -DPIN_STEPPER_STEP=25
    -DPIN_STEPPER_DIR=26
    ; TODO(HARDWARE): STEPPER_EN was 27 but conflicts with shared PIN_SERVO=27.
    ;   Reassign when wiring speedometer prototype.
    -DPIN_STEPPER_EN=33
    ; Optical home sensor (slotted opto-interrupter, active-low)
    -DPIN_STEPPER_HOME=13
    ; eInk display (Waveshare 1.54" tri-color, SPI)
    -DPIN_EINK_MOSI=23
    -DPIN_EINK_SCK=18
    ; TODO(HARDWARE): eInk CS was 5, BUSY was 4 — conflicts with shared
    ;   PIN_CAN_TX=5, PIN_CAN_RX=4. Reassign when wiring speedometer prototype.
    -DPIN_EINK_CS=15
    -DPIN_EINK_DC=17
    -DPIN_EINK_RST=16
    -DPIN_EINK_BUSY=2

; ── Body Controller ────────────────────────────────────────────────
[env:body_controller]
build_src_filter = +<body_controller/>
build_flags =
    ${env.build_flags}
    -DGAUGE_ROLE=BODY
    -DGAUGE_ROLE_NAME='"BODY "'
    -DLOG_ROLE=LogRole::BODY
    -DPIN_HALL_SENSOR=27
    -DPIN_KEY_ON=32
    -DPIN_BRAKE=33
    -DPIN_REGEN=25
    -DPIN_FAN=26
    -DPIN_REVERSE=34
    -DPIN_LEFT_TURN=35
    -DPIN_RIGHT_TURN=36
    ; Drivetrain constants
    -DDIFF_RATIO=3.909
    -DTIRE_DIAMETER_IN=26.5
    -DHALL_MAGNETS_PER_REV=2
    ; MGB 4-speed gear ratios (see docs/vehicle-specs.md)
    -DGEAR_RATIO_1=3.41
    -DGEAR_RATIO_2=2.166
    -DGEAR_RATIO_3=1.38
    -DGEAR_RATIO_4=1.00
    -DGEAR_RATIO_REV=3.09
    -DGEAR_TOLERANCE=0.15
    ; Odometer persistence
    -DODO_PERSIST_MILES=0.5
